<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LibQuicR: client.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">LibQuicR
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('client_8cpp-example.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">client.cpp</div></div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">// SPDX-FileCopyrightText: Copyright (c) 2024 Cisco Systems</span></div>
<div class="line"><span class="comment">// SPDX-License-Identifier: BSD-2-Clause</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;nlohmann/json.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;oss/cxxopts.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;spdlog/sinks/stdout_color_sinks.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;spdlog/spdlog.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="client_8h.html">quicr/client.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="object_8h.html">quicr/object.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;helper_functions.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;signal_handler.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;filesystem&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="publish__fetch__handler_8h.html">quicr/publish_fetch_handler.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using </span>json = nlohmann::json; <span class="comment">// NOLINT</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>qclient_vars {</div>
<div class="line">    <span class="keywordtype">bool</span> publish_clock{ <span class="keyword">false</span> };</div>
<div class="line">    std::optional&lt;uint64_t&gt; track_alias; </div>
<div class="line">    <span class="keywordtype">bool</span> record = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> playback = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> new_group = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> add_gaps = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> req_track_status = <span class="keyword">false</span>;</div>
<div class="line">    std::chrono::milliseconds playback_speed_ms(20);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>qclient_consts {</div>
<div class="line">    <span class="keyword">const</span> std::filesystem::path kMoqDataDir = std::filesystem::current_path() / <span class="stringliteral">&quot;moq_data&quot;</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>{</div>
<div class="line">    <span class="comment">// TODO: Escape/drop invalid filename characters.</span></div>
<div class="line">    std::string ToString(<span class="keyword">const</span> <a id="_a0" name="_a0"></a><a class="code hl_struct" href="structquicr_1_1_full_track_name.html">quicr::FullTrackName</a>&amp; ftn)</div>
<div class="line">    {</div>
<div class="line">        std::string str;</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; entries = ftn.<a id="a1" name="a1"></a><a class="code hl_variable" href="structquicr_1_1_full_track_name.html#aca157ed8599522f1690820a720b6b722">name_space</a>.<a id="a2" name="a2"></a><a class="code hl_function" href="classquicr_1_1_track_namespace.html#a32dc15e4ff8867523d2435875a99f00e">GetEntries</a>();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; entry : entries) {</div>
<div class="line">            str += std::string(entry.begin(), entry.end()) + <span class="charliteral">&#39;_&#39;</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        str += std::string(ftn.<a id="a3" name="a3"></a><a class="code hl_variable" href="structquicr_1_1_full_track_name.html#aa1200d2c7858e58eb2370434bb6580ee">name</a>.begin(), ftn.<a class="code hl_variable" href="structquicr_1_1_full_track_name.html#aa1200d2c7858e58eb2370434bb6580ee">name</a>.end());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> str;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>base64 {</div>
<div class="line">    <span class="comment">// From https://gist.github.com/williamdes/308b95ac9ef1ee89ae0143529c361d37;</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">constexpr</span> std::string_view kValues = <span class="stringliteral">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>; <span class="comment">//=</span></div>
<div class="line">    <span class="keyword">static</span> std::string Encode(<span class="keyword">const</span> std::string&amp; in)</div>
<div class="line">    {</div>
<div class="line">        std::string out;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">int</span> val = 0;</div>
<div class="line">        <span class="keywordtype">int</span> valb = -6;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (std::uint8_t c : in) {</div>
<div class="line">            val = (val &lt;&lt; 8) + c;</div>
<div class="line">            valb += 8;</div>
<div class="line">            <span class="keywordflow">while</span> (valb &gt;= 0) {</div>
<div class="line">                out += kValues[(val &gt;&gt; valb) &amp; 0x3F];</div>
<div class="line">                valb -= 6;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (valb &gt; -6) {</div>
<div class="line">            out += kValues[((val &lt;&lt; 8) &gt;&gt; (valb + 8)) &amp; 0x3F];</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">while</span> (out.size() % 4) {</div>
<div class="line">            out += <span class="charliteral">&#39;=&#39;</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> out;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    [[maybe_unused]] <span class="keyword">static</span> std::string Decode(<span class="keyword">const</span> std::string&amp; in)</div>
<div class="line">    {</div>
<div class="line">        std::string out;</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;int&gt; values(256, -1);</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 64; i++) {</div>
<div class="line">            values[kValues[i]] = i;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">int</span> val = 0;</div>
<div class="line">        <span class="keywordtype">int</span> valb = -8;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (std::uint8_t c : in) {</div>
<div class="line">            <span class="keywordflow">if</span> (values[c] == -1) {</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            val = (val &lt;&lt; 6) + values[c];</div>
<div class="line">            valb += 6;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (valb &gt;= 0) {</div>
<div class="line">                out += char((val &gt;&gt; valb) &amp; 0xFF);</div>
<div class="line">                valb -= 8;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> out;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>MySubscribeTrackHandler : <span class="keyword">public</span> <a id="_a4" name="_a4"></a><a class="code hl_class" href="classquicr_1_1_subscribe_track_handler.html">quicr::SubscribeTrackHandler</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    MySubscribeTrackHandler(<span class="keyword">const</span> quicr::FullTrackName&amp; full_track_name,</div>
<div class="line">                            quicr::messages::FilterType filter_type,</div>
<div class="line">                            <span class="keyword">const</span> std::optional&lt;JoiningFetch&gt;&amp; joining_fetch,</div>
<div class="line">                            <span class="keyword">const</span> std::filesystem::path&amp; dir = qclient_consts::kMoqDataDir)</div>
<div class="line">      : SubscribeTrackHandler(full_track_name, 3, quicr::messages::GroupOrder::kAscending, filter_type, joining_fetch)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (qclient_vars::record) {</div>
<div class="line">            std::filesystem::create_directory(dir);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> std::string name_str = ToString(full_track_name);</div>
<div class="line">            data_fs_.open(dir / (name_str + <span class="stringliteral">&quot;.dat&quot;</span>), std::ios::in | std::ios::out | std::ios::trunc);</div>
<div class="line"> </div>
<div class="line">            moq_fs_.open(dir / (name_str + <span class="stringliteral">&quot;.moq&quot;</span>), std::ios::in | std::ios::out | std::ios::trunc);</div>
<div class="line">            moq_fs_ &lt;&lt; json::array();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> ~MySubscribeTrackHandler()</div>
<div class="line">    {</div>
<div class="line">        data_fs_ &lt;&lt; std::endl;</div>
<div class="line">        data_fs_.close();</div>
<div class="line"> </div>
<div class="line">        moq_fs_ &lt;&lt; std::endl;</div>
<div class="line">        moq_fs_.close();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a id="a5" name="a5"></a><a class="code hl_function" href="classquicr_1_1_subscribe_track_handler.html#aa4df3bdf8ba34557c381aa0268bc5b7d">ObjectReceived</a>(<span class="keyword">const</span> quicr::ObjectHeaders&amp; hdr, <a id="a6" name="a6"></a><a class="code hl_typedef" href="namespacequicr.html#ae70de664ee7965d202a9dfccfbb12e12">quicr::BytesSpan</a> data)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">if</span> (qclient_vars::record) {</div>
<div class="line">            RecordObject(GetFullTrackName(), hdr, data);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        std::stringstream ext;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (hdr.<a id="a7" name="a7"></a><a class="code hl_variable" href="structquicr_1_1_object_headers.html#a5df4640f77a5d99d30563728691bc501">extensions</a>) {</div>
<div class="line">            ext &lt;&lt; <span class="stringliteral">&quot;mutable hdrs: &quot;</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [type, value] : hdr.<a class="code hl_variable" href="structquicr_1_1_object_headers.html#a5df4640f77a5d99d30563728691bc501">extensions</a>.value()) {</div>
<div class="line">                ext &lt;&lt; std::hex &lt;&lt; std::setfill(<span class="charliteral">&#39;0&#39;</span>) &lt;&lt; std::setw(2) &lt;&lt; type;</div>
<div class="line">                ext &lt;&lt; <span class="stringliteral">&quot; = &quot;</span> &lt;&lt; std::dec &lt;&lt; std::setw(0) &lt;&lt; uint64_t(quicr::UintVar(value)) &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (hdr.<a id="a8" name="a8"></a><a class="code hl_variable" href="structquicr_1_1_object_headers.html#a6ae96ec0cf4ad374d52d181f35ce7e11">immutable_extensions</a>) {</div>
<div class="line">            ext &lt;&lt; <span class="stringliteral">&quot;immutable hdrs: &quot;</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [type, value] : hdr.<a class="code hl_variable" href="structquicr_1_1_object_headers.html#a6ae96ec0cf4ad374d52d181f35ce7e11">immutable_extensions</a>.value()) {</div>
<div class="line">                ext &lt;&lt; std::hex &lt;&lt; std::setfill(<span class="charliteral">&#39;0&#39;</span>) &lt;&lt; std::setw(2) &lt;&lt; type;</div>
<div class="line">                ext &lt;&lt; <span class="stringliteral">&quot; = &quot;</span> &lt;&lt; std::dec &lt;&lt; std::setw(0) &lt;&lt; uint64_t(quicr::UintVar(value)) &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        std::string msg(data.begin(), data.end());</div>
<div class="line"> </div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;Received message: {} Group:{}, Object:{} - {}&quot;</span>, ext.str(), hdr.<a id="a9" name="a9"></a><a class="code hl_variable" href="structquicr_1_1_object_headers.html#a5f95043ef8044f6497e9eedc8cd20ff9">group_id</a>, hdr.<a id="a10" name="a10"></a><a class="code hl_variable" href="structquicr_1_1_object_headers.html#a544ac7b64c29d3adec1e76b4efefa5d5">object_id</a>, msg);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (qclient_vars::new_group &amp;&amp; not new_group_requested_) {</div>
<div class="line">            SPDLOG_INFO(<span class="stringliteral">&quot;Track alias: {} requesting new group&quot;</span>, <a id="a11" name="a11"></a><a class="code hl_function" href="classquicr_1_1_subscribe_track_handler.html#a73d8e7dfc1dfa07809aaec0daea79c37">GetTrackAlias</a>().value());</div>
<div class="line">            <a id="a12" name="a12"></a><a class="code hl_function" href="classquicr_1_1_subscribe_track_handler.html#a93b099d6a5c5862e121d6891ac5036af">RequestNewGroup</a>();</div>
<div class="line">            new_group_requested_ = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a id="a13" name="a13"></a><a class="code hl_function" href="classquicr_1_1_subscribe_track_handler.html#acc562217cd1bb34fc845cdde7a0fe570">StatusChanged</a>(Status status)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">switch</span> (status) {</div>
<div class="line">            <span class="keywordflow">case</span> Status::kOk: {</div>
<div class="line">                <span class="keywordflow">if</span> (<span class="keyword">auto</span> track_alias = <a class="code hl_function" href="classquicr_1_1_subscribe_track_handler.html#a73d8e7dfc1dfa07809aaec0daea79c37">GetTrackAlias</a>(); track_alias.has_value()) {</div>
<div class="line">                    SPDLOG_INFO(<span class="stringliteral">&quot;Track alias: {0} is ready to read&quot;</span>, track_alias.value());</div>
<div class="line">                }</div>
<div class="line">            } <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> RecordObject(<span class="keyword">const</span> quicr::FullTrackName&amp; ftn, <span class="keyword">const</span> quicr::ObjectHeaders&amp; hdr, <a class="code hl_typedef" href="namespacequicr.html#ae70de664ee7965d202a9dfccfbb12e12">quicr::BytesSpan</a> data)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> std::size_t data_offset = data_fs_.tellp();</div>
<div class="line">        data_fs_ &lt;&lt; std::string(data.begin(), data.end());</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;std::string&gt; ns_entries;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; entry : ftn.<a class="code hl_variable" href="structquicr_1_1_full_track_name.html#aca157ed8599522f1690820a720b6b722">name_space</a>.<a class="code hl_function" href="classquicr_1_1_track_namespace.html#a32dc15e4ff8867523d2435875a99f00e">GetEntries</a>()) {</div>
<div class="line">            ns_entries.push_back(base64::Encode({ entry.begin(), entry.end() }));</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> std::string name_str = ToString(GetFullTrackName());</div>
<div class="line">        <span class="keyword">const</span> std::string data_filename = name_str + <span class="stringliteral">&quot;.dat&quot;</span>;</div>
<div class="line"> </div>
<div class="line">        json j;</div>
<div class="line">        j[<span class="stringliteral">&quot;nameSpace&quot;</span>] = ns_entries;</div>
<div class="line">        j[<span class="stringliteral">&quot;trackName&quot;</span>] = base64::Encode(std::string(ftn.<a class="code hl_variable" href="structquicr_1_1_full_track_name.html#aa1200d2c7858e58eb2370434bb6580ee">name</a>.begin(), ftn.<a class="code hl_variable" href="structquicr_1_1_full_track_name.html#aa1200d2c7858e58eb2370434bb6580ee">name</a>.end()));</div>
<div class="line">        j[<span class="stringliteral">&quot;objectID&quot;</span>] = hdr.<a class="code hl_variable" href="structquicr_1_1_object_headers.html#a544ac7b64c29d3adec1e76b4efefa5d5">object_id</a>;</div>
<div class="line">        j[<span class="stringliteral">&quot;groupID&quot;</span>] = hdr.<a class="code hl_variable" href="structquicr_1_1_object_headers.html#a5f95043ef8044f6497e9eedc8cd20ff9">group_id</a>;</div>
<div class="line">        j[<span class="stringliteral">&quot;subGroup&quot;</span>] = hdr.<a id="a14" name="a14"></a><a class="code hl_variable" href="structquicr_1_1_object_headers.html#a05928bdabd0ac8c294486dba35099d18">subgroup_id</a>;</div>
<div class="line">        j[<span class="stringliteral">&quot;publisherPriority&quot;</span>] = hdr.<a id="a15" name="a15"></a><a class="code hl_variable" href="structquicr_1_1_object_headers.html#a7f1dbb9d56ecaa769b7b43128215c4bc">priority</a>.value();</div>
<div class="line">        j[<span class="stringliteral">&quot;maxCacheDuration&quot;</span>] = 0;</div>
<div class="line">        j[<span class="stringliteral">&quot;publisherDeliveryTimeout&quot;</span>] = 0;</div>
<div class="line">        j[<span class="stringliteral">&quot;receiveTime&quot;</span>] = std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(</div>
<div class="line">                             std::chrono::high_resolution_clock::now().time_since_epoch())</div>
<div class="line">                             .count();</div>
<div class="line">        j[<span class="stringliteral">&quot;dataFile&quot;</span>] = data_filename;</div>
<div class="line">        j[<span class="stringliteral">&quot;dataOffset&quot;</span>] = data_offset;</div>
<div class="line">        j[<span class="stringliteral">&quot;dataLength&quot;</span>] = hdr.<a id="a16" name="a16"></a><a class="code hl_variable" href="structquicr_1_1_object_headers.html#ad15c80dbc8580017173694db9db4d0d2">payload_length</a>;</div>
<div class="line"> </div>
<div class="line">        moq_fs_.clear();</div>
<div class="line">        moq_fs_.seekg(0);</div>
<div class="line">        json moq_j = json::parse(moq_fs_);</div>
<div class="line">        moq_j.push_back(j);</div>
<div class="line"> </div>
<div class="line">        moq_fs_.clear();</div>
<div class="line">        moq_fs_.seekg(0);</div>
<div class="line">        moq_fs_ &lt;&lt; moq_j.dump();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    std::ofstream data_fs_;</div>
<div class="line">    std::fstream moq_fs_;</div>
<div class="line">    <span class="keywordtype">bool</span> new_group_requested_ = <span class="keyword">false</span>;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>MyPublishTrackHandler : <span class="keyword">public</span> <a id="_a17" name="_a17"></a><a class="code hl_class" href="classquicr_1_1_publish_track_handler.html">quicr::PublishTrackHandler</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    MyPublishTrackHandler(<span class="keyword">const</span> quicr::FullTrackName&amp; full_track_name,</div>
<div class="line">                          quicr::TrackMode track_mode,</div>
<div class="line">                          uint8_t default_priority,</div>
<div class="line">                          uint32_t default_ttl)</div>
<div class="line">      : quicr::PublishTrackHandler(full_track_name, track_mode, default_priority, default_ttl)</div>
<div class="line">    {</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a id="a18" name="a18"></a><a class="code hl_function" href="classquicr_1_1_publish_track_handler.html#a85d2310272db252df775a681cc8b8884">StatusChanged</a>(Status status)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> alias = <a id="a19" name="a19"></a><a class="code hl_function" href="classquicr_1_1_publish_track_handler.html#ae1d84347753c980a4fba65ed740a94b1">GetTrackAlias</a>().value();</div>
<div class="line">        <span class="keywordflow">switch</span> (status) {</div>
<div class="line">            <span class="keywordflow">case</span> Status::kOk: {</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Publish track alias: {0} is ready to send&quot;</span>, alias);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">case</span> Status::kNoSubscribers: {</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Publish track alias: {0} has no subscribers&quot;</span>, alias);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">case</span> Status::kNewGroupRequested: {</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Publish track alias: {0} has new group request&quot;</span>, alias);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">case</span> Status::kSubscriptionUpdated: {</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Publish track alias: {0} has updated subscription&quot;</span>, alias);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">case</span> Status::kPaused: {</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Publish track alias: {0} is paused&quot;</span>, alias);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">case</span> Status::kPendingPublishOk: {</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Publish track alias: {0} is pending publish ok&quot;</span>, alias);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Publish track alias: {0} has status {1}&quot;</span>, alias, <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(status));</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>MyFetchTrackHandler : <span class="keyword">public</span> <a id="_a20" name="_a20"></a><a class="code hl_class" href="classquicr_1_1_fetch_track_handler.html">quicr::FetchTrackHandler</a></div>
<div class="line">{</div>
<div class="line">    MyFetchTrackHandler(<span class="keyword">const</span> quicr::FullTrackName&amp; full_track_name,</div>
<div class="line">                        uint64_t start_group,</div>
<div class="line">                        uint64_t start_object,</div>
<div class="line">                        uint64_t end_group,</div>
<div class="line">                        uint64_t end_object)</div>
<div class="line">      : FetchTrackHandler(full_track_name,</div>
<div class="line">                          3,</div>
<div class="line">                          quicr::messages::GroupOrder::kAscending,</div>
<div class="line">                          start_group,</div>
<div class="line">                          end_group,</div>
<div class="line">                          start_object,</div>
<div class="line">                          end_object)</div>
<div class="line">    {</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">auto</span> <a id="a21" name="a21"></a><a class="code hl_function" href="classquicr_1_1_fetch_track_handler.html#af93401d317fd218737230aec95de416c">Create</a>(<span class="keyword">const</span> quicr::FullTrackName&amp; full_track_name,</div>
<div class="line">                       uint64_t start_group,</div>
<div class="line">                       uint64_t start_object,</div>
<div class="line">                       uint64_t end_group,</div>
<div class="line">                       uint64_t end_object)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> std::shared_ptr&lt;MyFetchTrackHandler&gt;(</div>
<div class="line">          <span class="keyword">new</span> MyFetchTrackHandler(full_track_name, start_group, end_group, start_object, end_object));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code hl_function" href="classquicr_1_1_subscribe_track_handler.html#aa4df3bdf8ba34557c381aa0268bc5b7d">ObjectReceived</a>(<span class="keyword">const</span> quicr::ObjectHeaders&amp; headers, <a class="code hl_typedef" href="namespacequicr.html#ae70de664ee7965d202a9dfccfbb12e12">quicr::BytesSpan</a> data)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        std::string msg(data.begin(), data.end());</div>
<div class="line">        SPDLOG_INFO(</div>
<div class="line">          <span class="stringliteral">&quot;Received fetched object group_id: {} object_id: {} value: {}&quot;</span>, headers.<a class="code hl_variable" href="structquicr_1_1_object_headers.html#a5f95043ef8044f6497e9eedc8cd20ff9">group_id</a>, headers.<a class="code hl_variable" href="structquicr_1_1_object_headers.html#a544ac7b64c29d3adec1e76b4efefa5d5">object_id</a>, msg);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code hl_function" href="classquicr_1_1_subscribe_track_handler.html#acc562217cd1bb34fc845cdde7a0fe570">StatusChanged</a>(Status status)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">switch</span> (status) {</div>
<div class="line">            <span class="keywordflow">case</span> Status::kOk: {</div>
<div class="line">                <span class="keywordflow">if</span> (<span class="keyword">auto</span> track_alias = <a class="code hl_function" href="classquicr_1_1_subscribe_track_handler.html#a73d8e7dfc1dfa07809aaec0daea79c37">GetTrackAlias</a>(); track_alias.has_value()) {</div>
<div class="line">                    SPDLOG_INFO(<span class="stringliteral">&quot;Track alias: {0} is ready to read&quot;</span>, track_alias.value());</div>
<div class="line">                }</div>
<div class="line">            } <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">case</span> Status::kError: {</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Fetch failed&quot;</span>);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>MyClient : <span class="keyword">public</span> <a id="_a22" name="_a22"></a><a class="code hl_class" href="classquicr_1_1_client.html">quicr::Client</a></div>
<div class="line">{</div>
<div class="line">    MyClient(<span class="keyword">const</span> quicr::ClientConfig&amp; cfg, <span class="keywordtype">bool</span>&amp; stop_threads)</div>
<div class="line">      : quicr::Client(cfg)</div>
<div class="line">      , stop_threads_(stop_threads)</div>
<div class="line">    {</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">static</span> std::shared_ptr&lt;MyClient&gt; <a id="a23" name="a23"></a><a class="code hl_function" href="classquicr_1_1_client.html#abcb67bcd176e798b11301d5e1285c145">Create</a>(<span class="keyword">const</span> quicr::ClientConfig&amp; cfg, <span class="keywordtype">bool</span>&amp; stop_threads)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> std::shared_ptr&lt;MyClient&gt;(<span class="keyword">new</span> MyClient(cfg, stop_threads));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a id="a24" name="a24"></a><a class="code hl_function" href="classquicr_1_1_transport.html#af6b023296dcd922a3e590753aaa97bb3">StatusChanged</a>(Status status)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">switch</span> (status) {</div>
<div class="line">            <span class="keywordflow">case</span> Status::kReady:</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Connection ready&quot;</span>);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> Status::kConnecting:</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> Status::kPendingServerSetup:</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Connection connected and now pending server setup&quot;</span>);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Connection failed {0}&quot;</span>, <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(status));</div>
<div class="line">                stop_threads_ = <span class="keyword">true</span>;</div>
<div class="line">                moq_example::terminate = <span class="keyword">true</span>;</div>
<div class="line">                moq_example::termination_reason = <span class="stringliteral">&quot;Connection failed&quot;</span>;</div>
<div class="line">                moq_example::cv.notify_all();</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a id="a25" name="a25"></a><a class="code hl_function" href="classquicr_1_1_client.html#ac33e5c121b37a4a51310e0d2758a2eb4">AnnounceReceived</a>(<span class="keyword">const</span> quicr::TrackNamespace&amp; track_namespace,</div>
<div class="line">                          <span class="keyword">const</span> quicr::PublishAnnounceAttributes&amp;)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keyword">auto</span> th = quicr::TrackHash({ track_namespace, {} });</div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;Received announce for namespace_hash: {}&quot;</span>, th.track_namespace_hash);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a id="a26" name="a26"></a><a class="code hl_function" href="classquicr_1_1_client.html#ab22e0b13413ac17fdc3da8abd2f912fc">UnannounceReceived</a>(<span class="keyword">const</span> quicr::TrackNamespace&amp; track_namespace)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keyword">auto</span> th = quicr::TrackHash({ track_namespace, {} });</div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;Received unannounce for namespace_hash: {}&quot;</span>, th.track_namespace_hash);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a id="a27" name="a27"></a><a class="code hl_function" href="classquicr_1_1_client.html#ae9e0e0957f93f57d58264836d715c1cc">SubscribeAnnouncesStatusChanged</a>(<span class="keyword">const</span> quicr::TrackNamespace&amp; track_namespace,</div>
<div class="line">                                         std::optional&lt;quicr::messages::SubscribeNamespaceErrorCode&gt; error_code,</div>
<div class="line">                                         std::optional&lt;quicr::messages::ReasonPhrase&gt; reason)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keyword">auto</span> th = quicr::TrackHash({ track_namespace, {} });</div>
<div class="line">        <span class="keywordflow">if</span> (!error_code.has_value()) {</div>
<div class="line">            SPDLOG_INFO(<span class="stringliteral">&quot;Subscribe announces namespace_hash: {} status changed to OK&quot;</span>, th.track_namespace_hash);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        std::string reason_str;</div>
<div class="line">        <span class="keywordflow">if</span> (reason.has_value()) {</div>
<div class="line">            reason_str.assign(reason.value().begin(), reason.value().end());</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        SPDLOG_WARN(<span class="stringliteral">&quot;Subscribe announces to namespace_hash: {} has error {} with reason: {}&quot;</span>,</div>
<div class="line">                    th.track_namespace_hash,</div>
<div class="line">                    <span class="keyword">static_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(error_code.value()),</div>
<div class="line">                    reason_str);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> <a id="a28" name="a28"></a><a class="code hl_function" href="classquicr_1_1_client.html#a6941229a7e2f8b978440b1c5e31ac946">FetchReceived</a>(<a id="a29" name="a29"></a><a class="code hl_typedef" href="namespacequicr.html#ae332e51a43d09ae0300bd16654d671fc">quicr::ConnectionHandle</a> connection_handle,</div>
<div class="line">                       uint64_t request_id,</div>
<div class="line">                       <span class="keyword">const</span> quicr::FullTrackName&amp; track_full_name,</div>
<div class="line">                       <span class="keyword">const</span> quicr::messages::FetchAttributes&amp; attributes)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keyword">auto</span> pub_fetch_h = <a id="a30" name="a30"></a><a class="code hl_function" href="classquicr_1_1_publish_fetch_handler.html#a17a782189c94e6e4331fcc23e3c14326">quicr::PublishFetchHandler::Create</a>(</div>
<div class="line">          track_full_name, attributes.priority, request_id, attributes.group_order, 50000);</div>
<div class="line">        <a id="a31" name="a31"></a><a class="code hl_function" href="classquicr_1_1_client.html#a0d7798afe93e4d24cd61a68ea2ab9586">BindFetchTrack</a>(connection_handle, pub_fetch_h);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (uint64_t pub_group_number = attributes.start_location.group; pub_group_number &lt; attributes.end_group;</div>
<div class="line">             ++pub_group_number) {</div>
<div class="line">            quicr::ObjectHeaders headers{ .group_id = pub_group_number,</div>
<div class="line">                                          .object_id = 0,</div>
<div class="line">                                          .subgroup_id = 0,</div>
<div class="line">                                          .payload_length = 0,</div>
<div class="line">                                          .status = <a id="a32" name="a32"></a><a class="code hl_enumvalue" href="namespacequicr.html#a960fb04ec2c5b5aee1ff1b6b125ea4b3ad5dbdf8007e4468c85b9aa91312030e7">quicr::ObjectStatus::kAvailable</a>,</div>
<div class="line">                                          .priority = attributes.priority,</div>
<div class="line">                                          .ttl = 3000, <span class="comment">// in milliseconds</span></div>
<div class="line">                                          .track_mode = std::nullopt,</div>
<div class="line">                                          .extensions = std::nullopt,</div>
<div class="line">                                          .immutable_extensions = std::nullopt };</div>
<div class="line"> </div>
<div class="line">            std::string hello = <span class="stringliteral">&quot;Hello:&quot;</span> + std::to_string(pub_group_number);</div>
<div class="line">            std::vector&lt;uint8_t&gt; data_vec(hello.begin(), hello.end());</div>
<div class="line">            <a class="code hl_typedef" href="namespacequicr.html#ae70de664ee7965d202a9dfccfbb12e12">quicr::BytesSpan</a> data{ data_vec.data(), data_vec.size() };</div>
<div class="line">            pub_fetch_h-&gt;PublishObject(headers, data);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a id="a33" name="a33"></a><a class="code hl_function" href="classquicr_1_1_transport.html#aa2d05f889c978960a851175054268e01">TrackStatusResponseReceived</a>(<a class="code hl_typedef" href="namespacequicr.html#ae332e51a43d09ae0300bd16654d671fc">quicr::ConnectionHandle</a>,</div>
<div class="line">                                     uint64_t request_id,</div>
<div class="line">                                     <span class="keyword">const</span> quicr::SubscribeResponse&amp; response)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">switch</span> (response.reason_code) {</div>
<div class="line">            <span class="keywordflow">case</span> quicr::SubscribeResponse::ReasonCode::kOk:</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Request track status OK response request_id: {} largest group: {} object: {}&quot;</span>,</div>
<div class="line">                            request_id,</div>
<div class="line">                            response.largest_location.has_value() ? response.largest_location-&gt;group : 0,</div>
<div class="line">                            response.largest_location.has_value() ? response.largest_location-&gt;object : 0);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Request track status response ERROR request_id: {} error: {} reason: {}&quot;</span>,</div>
<div class="line">                            request_id,</div>
<div class="line">                            <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(response.reason_code),</div>
<div class="line">                            response.error_reason.has_value() ? response.error_reason.value() : <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">bool</span>&amp; stop_threads_;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*===========================================================================*/</span></div>
<div class="line"><span class="comment">// Publisher Thread to perform publishing</span></div>
<div class="line"><span class="comment">/*===========================================================================*/</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">DoPublisher(<span class="keyword">const</span> <a class="code hl_struct" href="structquicr_1_1_full_track_name.html">quicr::FullTrackName</a>&amp; full_track_name,</div>
<div class="line">            <span class="keyword">const</span> std::shared_ptr&lt;quicr::Client&gt;&amp; client,</div>
<div class="line">            <span class="keywordtype">bool</span> use_announce,</div>
<div class="line">            <span class="keywordtype">bool</span>&amp; stop)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">auto</span> track_handler = std::make_shared&lt;MyPublishTrackHandler&gt;(</div>
<div class="line">      full_track_name, quicr::TrackMode::kStream <span class="comment">/*mode*/</span>, 2 <span class="comment">/*priority*/</span>, 3000 <span class="comment">/*ttl*/</span>);</div>
<div class="line"> </div>
<div class="line">    track_handler-&gt;SetUseAnnounce(use_announce);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (qclient_vars::track_alias.has_value()) {</div>
<div class="line">        track_handler-&gt;SetTrackAlias(*qclient_vars::track_alias);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    SPDLOG_INFO(<span class="stringliteral">&quot;Started publisher track&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> published_track{ <span class="keyword">false</span> };</div>
<div class="line">    <span class="keywordtype">bool</span> sending{ <span class="keyword">false</span> };</div>
<div class="line">    uint64_t group_id{ 0 };</div>
<div class="line">    uint64_t object_id{ 0 };</div>
<div class="line">    uint64_t subgroup_id{ 0 };</div>
<div class="line"> </div>
<div class="line">    std::ifstream moq_fs;</div>
<div class="line">    std::ifstream data_fs;</div>
<div class="line"> </div>
<div class="line">    std::deque&lt;std::pair&lt;quicr::ObjectHeaders, quicr::Bytes&gt;&gt; messages;</div>
<div class="line">    <span class="keywordflow">if</span> (qclient_vars::playback) {</div>
<div class="line">        <span class="keyword">const</span> std::string name_str = ToString(full_track_name);</div>
<div class="line">        moq_fs.open(qclient_consts::kMoqDataDir / (name_str + <span class="stringliteral">&quot;.moq&quot;</span>), std::ios::in);</div>
<div class="line">        data_fs.open(qclient_consts::kMoqDataDir / (name_str + <span class="stringliteral">&quot;.dat&quot;</span>), std::ios::in);</div>
<div class="line"> </div>
<div class="line">        std::string data;</div>
<div class="line">        std::getline(data_fs, data);</div>
<div class="line"> </div>
<div class="line">        json moq_arr_j = json::parse(moq_fs);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; moq_j : moq_arr_j) {</div>
<div class="line">            <a id="_a34" name="_a34"></a><a class="code hl_struct" href="structquicr_1_1_object_headers.html">quicr::ObjectHeaders</a> hdr{</div>
<div class="line">                .group_id = moq_j[<span class="stringliteral">&quot;groupID&quot;</span>],</div>
<div class="line">                .object_id = moq_j[<span class="stringliteral">&quot;objectID&quot;</span>],</div>
<div class="line">                .subgroup_id = moq_j[<span class="stringliteral">&quot;subGroup&quot;</span>],</div>
<div class="line">                .payload_length = moq_j[<span class="stringliteral">&quot;dataLength&quot;</span>],</div>
<div class="line">                .status = <a class="code hl_enumvalue" href="namespacequicr.html#a960fb04ec2c5b5aee1ff1b6b125ea4b3ad5dbdf8007e4468c85b9aa91312030e7">quicr::ObjectStatus::kAvailable</a>,</div>
<div class="line">                .priority = moq_j[<span class="stringliteral">&quot;publisherPriority&quot;</span>],</div>
<div class="line">                .ttl = std::nullopt,</div>
<div class="line">                .track_mode = std::nullopt,</div>
<div class="line">                .extensions = std::nullopt,</div>
<div class="line">                .immutable_extensions = std::nullopt,</div>
<div class="line">            };</div>
<div class="line"> </div>
<div class="line">            std::size_t data_offset = moq_j[<span class="stringliteral">&quot;dataOffset&quot;</span>];</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">auto</span>&amp; msg = messages.emplace_back(std::make_pair(hdr, <a id="_a35" name="_a35"></a><a class="code hl_typedef" href="namespacequicr.html#a196ac5046236a7e948d3b5a766ac02ee">quicr::Bytes</a>{}));</div>
<div class="line">            msg.second.assign(std::next(data.begin(), data_offset),</div>
<div class="line">                              std::next(data.begin(), data_offset + hdr.<a class="code hl_variable" href="structquicr_1_1_object_headers.html#ad15c80dbc8580017173694db9db4d0d2">payload_length</a>));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (not stop) {</div>
<div class="line">        <span class="keywordflow">if</span> ((!published_track) &amp;&amp; (client-&gt;GetStatus() == MyClient::Status::kReady)) {</div>
<div class="line">            SPDLOG_INFO(<span class="stringliteral">&quot;Publish track &quot;</span>);</div>
<div class="line">            client-&gt;PublishTrack(track_handler);</div>
<div class="line">            published_track = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">switch</span> (track_handler-&gt;GetStatus()) {</div>
<div class="line">            <span class="keywordflow">case</span> MyPublishTrackHandler::Status::kOk:</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> MyPublishTrackHandler::Status::kNewGroupRequested:</div>
<div class="line">                <span class="keywordflow">if</span> (object_id) {</div>
<div class="line">                    group_id++;</div>
<div class="line">                    object_id = 0;</div>
<div class="line">                    subgroup_id = 0;</div>
<div class="line">                }</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;New Group Requested: Now using group {0}&quot;</span>, group_id);</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> MyPublishTrackHandler::Status::kSubscriptionUpdated:</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;subscribe updated&quot;</span>);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> MyPublishTrackHandler::Status::kNoSubscribers:</div>
<div class="line">                <span class="comment">// Start a new group when a subscriber joins</span></div>
<div class="line">                <span class="keywordflow">if</span> (object_id) {</div>
<div class="line">                    group_id++;</div>
<div class="line">                    object_id = 0;</div>
<div class="line">                    subgroup_id = 0;</div>
<div class="line">                }</div>
<div class="line">                [[fallthrough]];</div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                std::this_thread::sleep_for(std::chrono::milliseconds(100));</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (!sending) {</div>
<div class="line">            SPDLOG_INFO(<span class="stringliteral">&quot;--------------------------------------------------------------------------&quot;</span>);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (qclient_vars::publish_clock) {</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot; Publishing clock timestamp every second&quot;</span>);</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot; Type message and press enter to send&quot;</span>);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            SPDLOG_INFO(<span class="stringliteral">&quot;--------------------------------------------------------------------------&quot;</span>);</div>
<div class="line">            sending = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (qclient_vars::playback) {</div>
<div class="line">            <span class="keyword">const</span> <span class="keyword">auto</span> [hdr, msg] = messages.front();</div>
<div class="line">            messages.pop_front();</div>
<div class="line"> </div>
<div class="line">            SPDLOG_INFO(<span class="stringliteral">&quot;Send message: {0}&quot;</span>, std::string(msg.begin(), msg.end()));</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">try</span> {</div>
<div class="line">                <span class="keyword">auto</span> status = track_handler-&gt;PublishObject(hdr, msg);</div>
<div class="line">                <span class="keywordflow">if</span> (status != <span class="keyword">decltype</span>(status)::kOk) {</div>
<div class="line">                    <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;PublishObject returned status=&quot;</span> +</div>
<div class="line">                                             std::to_string(<span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(status)));</div>
<div class="line">                }</div>
<div class="line">            } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">                SPDLOG_ERROR(<span class="stringliteral">&quot;Caught exception trying to publish. (error={})&quot;</span>, e.what());</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            std::this_thread::sleep_for(qclient_vars::playback_speed_ms);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (messages.empty()) {</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (object_id &amp;&amp; object_id % 15 == 0) { <span class="comment">// Set new group</span></div>
<div class="line">            object_id = 0;</div>
<div class="line">            subgroup_id = 0;</div>
<div class="line">            group_id++;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (qclient_vars::add_gaps &amp;&amp; group_id &amp;&amp; group_id % 4 == 0) {</div>
<div class="line">            group_id += 1;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (qclient_vars::add_gaps &amp;&amp; object_id &amp;&amp; object_id % 8 == 0) {</div>
<div class="line">            object_id += 2;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        std::string msg;</div>
<div class="line">        <span class="keywordflow">if</span> (qclient_vars::publish_clock) {</div>
<div class="line">            std::this_thread::sleep_for(std::chrono::milliseconds(999));</div>
<div class="line">            msg = quicr::example::GetTimeStr();</div>
<div class="line">            SPDLOG_INFO(<span class="stringliteral">&quot;Group:{0} Object:{1}, Msg:{2}&quot;</span>, group_id, object_id, msg);</div>
<div class="line">        } <span class="keywordflow">else</span> { <span class="comment">// stdin</span></div>
<div class="line">            getline(std::cin, msg);</div>
<div class="line">            SPDLOG_INFO(<span class="stringliteral">&quot;Send message: {0}&quot;</span>, msg);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_struct" href="structquicr_1_1_object_headers.html">quicr::ObjectHeaders</a> obj_headers = {</div>
<div class="line">            group_id,       object_id++,    subgroup_id,  msg.size(),   <a class="code hl_enumvalue" href="namespacequicr.html#a960fb04ec2c5b5aee1ff1b6b125ea4b3ad5dbdf8007e4468c85b9aa91312030e7">quicr::ObjectStatus::kAvailable</a>,</div>
<div class="line">            2 <span class="comment">/*priority*/</span>, 3000 <span class="comment">/* ttl */</span>, std::nullopt, std::nullopt, std::nullopt</div>
<div class="line">        };</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">try</span> {</div>
<div class="line">            <span class="keywordflow">if</span> (track_handler-&gt;CanPublish()) {</div>
<div class="line">                <span class="keyword">auto</span> status =</div>
<div class="line">                  track_handler-&gt;PublishObject(obj_headers, { <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(msg.data()), msg.size() });</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> (status == <span class="keyword">decltype</span>(status)::kPaused) {</div>
<div class="line">                    SPDLOG_INFO(<span class="stringliteral">&quot;Publish is paused&quot;</span>);</div>
<div class="line">                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <span class="keyword">decltype</span>(status)::kNoSubscribers) {</div>
<div class="line">                    SPDLOG_INFO(<span class="stringliteral">&quot;Publish has no subscribers&quot;</span>);</div>
<div class="line">                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status != <span class="keyword">decltype</span>(status)::kOk) {</div>
<div class="line">                    <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;PublishObject returned status=&quot;</span> +</div>
<div class="line">                                             std::to_string(<span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(status)));</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">            SPDLOG_ERROR(<span class="stringliteral">&quot;Caught exception trying to publish. (error={})&quot;</span>, e.what());</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    client-&gt;UnpublishTrack(track_handler);</div>
<div class="line">    std::this_thread::sleep_for(std::chrono::milliseconds(100));</div>
<div class="line"> </div>
<div class="line">    SPDLOG_INFO(<span class="stringliteral">&quot;Publisher done track&quot;</span>);</div>
<div class="line">    moq_example::terminate = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*===========================================================================*/</span></div>
<div class="line"><span class="comment">// Subscriber thread to perform subscribe</span></div>
<div class="line"><span class="comment">/*===========================================================================*/</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">DoSubscriber(<span class="keyword">const</span> <a class="code hl_struct" href="structquicr_1_1_full_track_name.html">quicr::FullTrackName</a>&amp; full_track_name,</div>
<div class="line">             <span class="keyword">const</span> std::shared_ptr&lt;quicr::Client&gt;&amp; client,</div>
<div class="line">             quicr::messages::FilterType filter_type,</div>
<div class="line">             <span class="keyword">const</span> <span class="keywordtype">bool</span>&amp; stop,</div>
<div class="line">             <span class="keyword">const</span> std::optional&lt;std::uint64_t&gt; join_fetch,</div>
<div class="line">             <span class="keyword">const</span> <span class="keywordtype">bool</span> absolute)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">typedef</span> <a id="_a36" name="_a36"></a><a class="code hl_struct" href="structquicr_1_1_subscribe_track_handler_1_1_joining_fetch.html">quicr::SubscribeTrackHandler::JoiningFetch</a> Fetch;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> joining_fetch = join_fetch.has_value()</div>
<div class="line">                                 ? Fetch{ 4, quicr::messages::GroupOrder::kAscending, {}, *join_fetch, absolute }</div>
<div class="line">                                 : std::optional&lt;Fetch&gt;(std::nullopt);</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> track_handler = std::make_shared&lt;MySubscribeTrackHandler&gt;(full_track_name, filter_type, joining_fetch);</div>
<div class="line"> </div>
<div class="line">    SPDLOG_INFO(<span class="stringliteral">&quot;Started subscriber&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> subscribe_track{ <span class="keyword">false</span> };</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (not stop) {</div>
<div class="line">        <span class="keywordflow">if</span> ((!subscribe_track) &amp;&amp; (client-&gt;GetStatus() == MyClient::Status::kReady)) {</div>
<div class="line">            SPDLOG_INFO(<span class="stringliteral">&quot;Subscribing to track&quot;</span>);</div>
<div class="line">            client-&gt;SubscribeTrack(track_handler);</div>
<div class="line">            subscribe_track = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(500));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    client-&gt;UnsubscribeTrack(track_handler);</div>
<div class="line"> </div>
<div class="line">    std::this_thread::sleep_for(std::chrono::milliseconds(100));</div>
<div class="line"> </div>
<div class="line">    SPDLOG_INFO(<span class="stringliteral">&quot;Subscriber done track&quot;</span>);</div>
<div class="line">    moq_example::terminate = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*===========================================================================*/</span></div>
<div class="line"><span class="comment">// Fetch thread to perform fetch</span></div>
<div class="line"><span class="comment">/*===========================================================================*/</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>Range</div>
<div class="line">{</div>
<div class="line">    uint64_t start;</div>
<div class="line">    uint64_t end;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">DoFetch(<span class="keyword">const</span> <a class="code hl_struct" href="structquicr_1_1_full_track_name.html">quicr::FullTrackName</a>&amp; full_track_name,</div>
<div class="line">        <span class="keyword">const</span> Range&amp; group_range,</div>
<div class="line">        <span class="keyword">const</span> Range&amp; object_range,</div>
<div class="line">        <span class="keyword">const</span> std::shared_ptr&lt;quicr::Client&gt;&amp; client,</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span>&amp; stop)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">auto</span> track_handler = MyFetchTrackHandler::Create(</div>
<div class="line">      full_track_name, group_range.start, object_range.start, group_range.end, object_range.end);</div>
<div class="line"> </div>
<div class="line">    SPDLOG_INFO(<span class="stringliteral">&quot;Started fetch&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> fetch_track{ <span class="keyword">false</span> };</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (not stop) {</div>
<div class="line">        <span class="keywordflow">if</span> ((!fetch_track) &amp;&amp; (client-&gt;GetStatus() == MyClient::Status::kReady)) {</div>
<div class="line">            SPDLOG_INFO(<span class="stringliteral">&quot;Fetching track&quot;</span>);</div>
<div class="line">            client-&gt;FetchTrack(track_handler);</div>
<div class="line">            fetch_track = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (track_handler-&gt;GetStatus() == <a id="_a37" name="_a37"></a><a class="code hl_enumvalue" href="classquicr_1_1_subscribe_track_handler.html#a9de21a18d0ef99ddba39efc9833d74eea78076a6dd163ca654a4258f3d295d408">quicr::FetchTrackHandler::Status::kPendingResponse</a>) {</div>
<div class="line">            <span class="comment">// do nothing...</span></div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fetch_track || (track_handler-&gt;GetStatus() != <a id="_a38" name="_a38"></a><a class="code hl_enumvalue" href="classquicr_1_1_subscribe_track_handler.html#a9de21a18d0ef99ddba39efc9833d74eeae69fa9a656f76dd8a4d89f21992b2d3a">quicr::FetchTrackHandler::Status::kOk</a>)) {</div>
<div class="line">            SPDLOG_INFO(<span class="stringliteral">&quot;GetStatus() != quicr::FetchTrackHandler::Status::kOk {}&quot;</span>, (<span class="keywordtype">int</span>)track_handler-&gt;GetStatus());</div>
<div class="line">            moq_example::terminate = <span class="keyword">true</span>;</div>
<div class="line">            moq_example::cv.notify_all();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(500));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    client-&gt;CancelFetchTrack(track_handler);</div>
<div class="line"> </div>
<div class="line">    std::this_thread::sleep_for(std::chrono::milliseconds(100));</div>
<div class="line"> </div>
<div class="line">    moq_example::terminate = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*===========================================================================*/</span></div>
<div class="line"><span class="comment">// Main program</span></div>
<div class="line"><span class="comment">/*===========================================================================*/</span></div>
<div class="line"> </div>
<div class="line"><a id="_a39" name="_a39"></a><a class="code hl_struct" href="structquicr_1_1_client_config.html">quicr::ClientConfig</a></div>
<div class="line">InitConfig(cxxopts::ParseResult&amp; cli_opts, <span class="keywordtype">bool</span>&amp; enable_pub, <span class="keywordtype">bool</span>&amp; enable_sub, <span class="keywordtype">bool</span>&amp; enable_fetch, <span class="keywordtype">bool</span>&amp; use_announce)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_struct" href="structquicr_1_1_client_config.html">quicr::ClientConfig</a> config;</div>
<div class="line"> </div>
<div class="line">    std::string qlog_path;</div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;qlog&quot;</span>)) {</div>
<div class="line">        qlog_path = cli_opts[<span class="stringliteral">&quot;qlog&quot;</span>].as&lt;std::string&gt;();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;debug&quot;</span>) &amp;&amp; cli_opts[<span class="stringliteral">&quot;debug&quot;</span>].as&lt;<span class="keywordtype">bool</span>&gt;() == <span class="keyword">true</span>) {</div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;setting debug level&quot;</span>);</div>
<div class="line">        spdlog::set_level(spdlog::level::debug);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;version&quot;</span>) &amp;&amp; cli_opts[<span class="stringliteral">&quot;version&quot;</span>].as&lt;<span class="keywordtype">bool</span>&gt;() == <span class="keyword">true</span>) {</div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;QuicR library version: {}&quot;</span>, QUICR_VERSION);</div>
<div class="line">        exit(0);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;pub_namespace&quot;</span>) &amp;&amp; cli_opts.count(<span class="stringliteral">&quot;pub_name&quot;</span>)) {</div>
<div class="line">        enable_pub = <span class="keyword">true</span>;</div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;Publisher enabled using track namespace: {0} name: {1}&quot;</span>,</div>
<div class="line">                    cli_opts[<span class="stringliteral">&quot;pub_namespace&quot;</span>].as&lt;std::string&gt;(),</div>
<div class="line">                    cli_opts[<span class="stringliteral">&quot;pub_name&quot;</span>].as&lt;std::string&gt;());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;use_announce&quot;</span>)) {</div>
<div class="line">        use_announce = <span class="keyword">true</span>;</div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;Publisher will use announce flow&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;clock&quot;</span>) &amp;&amp; cli_opts[<span class="stringliteral">&quot;clock&quot;</span>].as&lt;<span class="keywordtype">bool</span>&gt;() == <span class="keyword">true</span>) {</div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;Running in clock publish mode&quot;</span>);</div>
<div class="line">        qclient_vars::publish_clock = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;sub_namespace&quot;</span>) &amp;&amp; cli_opts.count(<span class="stringliteral">&quot;sub_name&quot;</span>)) {</div>
<div class="line">        enable_sub = <span class="keyword">true</span>;</div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;Subscriber enabled using track namespace: {0} name: {1}&quot;</span>,</div>
<div class="line">                    cli_opts[<span class="stringliteral">&quot;sub_namespace&quot;</span>].as&lt;std::string&gt;(),</div>
<div class="line">                    cli_opts[<span class="stringliteral">&quot;sub_name&quot;</span>].as&lt;std::string&gt;());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;fetch_namespace&quot;</span>) &amp;&amp; cli_opts.count(<span class="stringliteral">&quot;fetch_name&quot;</span>)) {</div>
<div class="line">        enable_fetch = <span class="keyword">true</span>;</div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;Subscriber enabled using track namespace: {0} name: {1}&quot;</span>,</div>
<div class="line">                    cli_opts[<span class="stringliteral">&quot;fetch_namespace&quot;</span>].as&lt;std::string&gt;(),</div>
<div class="line">                    cli_opts[<span class="stringliteral">&quot;fetch_name&quot;</span>].as&lt;std::string&gt;());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;track_alias&quot;</span>)) {</div>
<div class="line">        qclient_vars::track_alias = cli_opts[<span class="stringliteral">&quot;track_alias&quot;</span>].as&lt;uint64_t&gt;();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;record&quot;</span>)) {</div>
<div class="line">        qclient_vars::record = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;playback&quot;</span>)) {</div>
<div class="line">        qclient_vars::playback = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;gaps&quot;</span>) &amp;&amp; cli_opts[<span class="stringliteral">&quot;gaps&quot;</span>].as&lt;<span class="keywordtype">bool</span>&gt;() == <span class="keyword">true</span>) {</div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;Adding gaps to group and objects&quot;</span>);</div>
<div class="line">        qclient_vars::add_gaps = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;new_group&quot;</span>)) {</div>
<div class="line">        qclient_vars::new_group = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;track_status&quot;</span>)) {</div>
<div class="line">        qclient_vars::req_track_status = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;playback_speed_ms&quot;</span>)) {</div>
<div class="line">        qclient_vars::playback_speed_ms = std::chrono::milliseconds(cli_opts[<span class="stringliteral">&quot;playback_speed_ms&quot;</span>].as&lt;uint64_t&gt;());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cli_opts.count(<span class="stringliteral">&quot;ssl_keylog&quot;</span>) &amp;&amp; cli_opts[<span class="stringliteral">&quot;ssl_keylog&quot;</span>].as&lt;<span class="keywordtype">bool</span>&gt;() == <span class="keyword">true</span>) {</div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;SSL Keylog enabled&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    config.<a id="a40" name="a40"></a><a class="code hl_variable" href="structquicr_1_1_config.html#ac61dcd9337d55b4694552338af12fe2e">endpoint_id</a> = cli_opts[<span class="stringliteral">&quot;endpoint_id&quot;</span>].as&lt;std::string&gt;();</div>
<div class="line">    config.<a id="a41" name="a41"></a><a class="code hl_variable" href="structquicr_1_1_client_config.html#aa6b0b5406607428025ea40d64f18d570">connect_uri</a> = cli_opts[<span class="stringliteral">&quot;url&quot;</span>].as&lt;std::string&gt;();</div>
<div class="line">    config.<a id="a42" name="a42"></a><a class="code hl_variable" href="structquicr_1_1_config.html#ad8895576bc8e8fba62da81e6096c1aea">transport_config</a>.debug = cli_opts[<span class="stringliteral">&quot;debug&quot;</span>].as&lt;<span class="keywordtype">bool</span>&gt;();</div>
<div class="line">    config.<a class="code hl_variable" href="structquicr_1_1_config.html#ad8895576bc8e8fba62da81e6096c1aea">transport_config</a>.ssl_keylog = cli_opts[<span class="stringliteral">&quot;ssl_keylog&quot;</span>].as&lt;<span class="keywordtype">bool</span>&gt;();</div>
<div class="line"> </div>
<div class="line">    config.<a class="code hl_variable" href="structquicr_1_1_config.html#ad8895576bc8e8fba62da81e6096c1aea">transport_config</a>.use_reset_wait_strategy = <span class="keyword">false</span>;</div>
<div class="line">    config.<a class="code hl_variable" href="structquicr_1_1_config.html#ad8895576bc8e8fba62da81e6096c1aea">transport_config</a>.time_queue_max_duration = 5000;</div>
<div class="line">    config.<a class="code hl_variable" href="structquicr_1_1_config.html#ad8895576bc8e8fba62da81e6096c1aea">transport_config</a>.tls_cert_filename = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">    config.<a class="code hl_variable" href="structquicr_1_1_config.html#ad8895576bc8e8fba62da81e6096c1aea">transport_config</a>.tls_key_filename = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">    config.<a class="code hl_variable" href="structquicr_1_1_config.html#ad8895576bc8e8fba62da81e6096c1aea">transport_config</a>.quic_qlog_path = qlog_path;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> config;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> result_code = EXIT_SUCCESS;</div>
<div class="line"> </div>
<div class="line">    cxxopts::Options options(<span class="stringliteral">&quot;qclient&quot;</span>,</div>
<div class="line">                             std::string(<span class="stringliteral">&quot;MOQ Example Client using QuicR Version: &quot;</span>) + std::string(QUICR_VERSION));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// clang-format off</span></div>
<div class="line">    options.set_width(75)</div>
<div class="line">      .set_tab_expansion()</div>
<div class="line">      <span class="comment">//.allow_unrecognised_options()</span></div>
<div class="line">      .add_options()</div>
<div class="line">        (<span class="stringliteral">&quot;h,help&quot;</span>, <span class="stringliteral">&quot;Print help&quot;</span>)</div>
<div class="line">        (<span class="stringliteral">&quot;d,debug&quot;</span>, <span class="stringliteral">&quot;Enable debugging&quot;</span>) <span class="comment">// a bool parameter</span></div>
<div class="line">        (<span class="stringliteral">&quot;v,version&quot;</span>, <span class="stringliteral">&quot;QuicR Version&quot;</span>)                                        <span class="comment">// a bool parameter</span></div>
<div class="line">        (<span class="stringliteral">&quot;r,url&quot;</span>, <span class="stringliteral">&quot;Relay URL&quot;</span>, cxxopts::value&lt;std::string&gt;()-&gt;default_value(<span class="stringliteral">&quot;moq://localhost:1234&quot;</span>))</div>
<div class="line">        (<span class="stringliteral">&quot;e,endpoint_id&quot;</span>, <span class="stringliteral">&quot;This client endpoint ID&quot;</span>, cxxopts::value&lt;std::string&gt;()-&gt;default_value(<span class="stringliteral">&quot;moq-client&quot;</span>))</div>
<div class="line">        (<span class="stringliteral">&quot;q,qlog&quot;</span>, <span class="stringliteral">&quot;Enable qlog using path&quot;</span>, cxxopts::value&lt;std::string&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;s,ssl_keylog&quot;</span>, <span class="stringliteral">&quot;Enable SSL Keylog for transport debugging&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    options.add_options(<span class="stringliteral">&quot;Publisher&quot;</span>)</div>
<div class="line">        (<span class="stringliteral">&quot;use_announce&quot;</span>, <span class="stringliteral">&quot;Use Announce flow instead of publish flow&quot;</span>, cxxopts::value&lt;bool&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;track_alias&quot;</span>, <span class="stringliteral">&quot;Track alias to use&quot;</span>, cxxopts::value&lt;uint64_t&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;pub_namespace&quot;</span>, <span class="stringliteral">&quot;Track namespace&quot;</span>, cxxopts::value&lt;std::string&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;pub_name&quot;</span>, <span class="stringliteral">&quot;Track name&quot;</span>, cxxopts::value&lt;std::string&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;clock&quot;</span>, <span class="stringliteral">&quot;Publish clock timestamp every second instead of using STDIN chat&quot;</span>)</div>
<div class="line">        (<span class="stringliteral">&quot;playback&quot;</span>, <span class="stringliteral">&quot;Playback recorded data from moq and dat files&quot;</span>, cxxopts::value&lt;bool&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;playback_speed_ms&quot;</span>, <span class="stringliteral">&quot;Playback speed in ms&quot;</span>, cxxopts::value&lt;std::uint64_t&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;gaps&quot;</span>, <span class="stringliteral">&quot;Add gaps to groups and objects&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    options.add_options(<span class="stringliteral">&quot;Subscriber&quot;</span>)</div>
<div class="line">        (<span class="stringliteral">&quot;sub_namespace&quot;</span>, <span class="stringliteral">&quot;Track namespace&quot;</span>, cxxopts::value&lt;std::string&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;sub_name&quot;</span>, <span class="stringliteral">&quot;Track name&quot;</span>, cxxopts::value&lt;std::string&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;start_point&quot;</span>, <span class="stringliteral">&quot;Start point for Subscription - 0 for from the beginning, 1 from the latest object&quot;</span>, cxxopts::value&lt;uint64_t&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;sub_announces&quot;</span>, <span class="stringliteral">&quot;Prefix namespace to subscribe announces to&quot;</span>, cxxopts::value&lt;std::string&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;record&quot;</span>, <span class="stringliteral">&quot;Record incoming data to moq and dat files&quot;</span>, cxxopts::value&lt;bool&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;new_group&quot;</span>, <span class="stringliteral">&quot;Request new group on subscribe&quot;</span>, cxxopts::value&lt;bool&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;joining_fetch&quot;</span>, <span class="stringliteral">&quot;Subscribe with a joining fetch using this joining start&quot;</span>, cxxopts::value&lt;std::uint64_t&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;absolute&quot;</span>, <span class="stringliteral">&quot;Joining fetch will be absolute not relative&quot;</span>, cxxopts::value&lt;bool&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;track_status&quot;</span>, <span class="stringliteral">&quot;Request track status using sub_namespace and sub_name options&quot;</span>, cxxopts::value&lt;bool&gt;());</div>
<div class="line"> </div>
<div class="line">    options.add_options(<span class="stringliteral">&quot;Fetcher&quot;</span>)</div>
<div class="line">        (<span class="stringliteral">&quot;fetch_namespace&quot;</span>, <span class="stringliteral">&quot;Track namespace&quot;</span>, cxxopts::value&lt;std::string&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;fetch_name&quot;</span>, <span class="stringliteral">&quot;Track name&quot;</span>, cxxopts::value&lt;std::string&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;start_group&quot;</span>, <span class="stringliteral">&quot;Starting group ID&quot;</span>, cxxopts::value&lt;uint64_t&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;end_group&quot;</span>, <span class="stringliteral">&quot;One past the final group ID&quot;</span>, cxxopts::value&lt;uint64_t&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;start_object&quot;</span>, <span class="stringliteral">&quot;The starting object ID within the group&quot;</span>, cxxopts::value&lt;uint64_t&gt;())</div>
<div class="line">        (<span class="stringliteral">&quot;end_object&quot;</span>, <span class="stringliteral">&quot;One past the final object ID in the group&quot;</span>, cxxopts::value&lt;uint64_t&gt;());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// clang-format on</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> result = options.parse(argc, argv);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (result.count(<span class="stringliteral">&quot;help&quot;</span>)) {</div>
<div class="line">        std::cout &lt;&lt; options.help({ <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;Publisher&quot;</span>, <span class="stringliteral">&quot;Subscriber&quot;</span>, <span class="stringliteral">&quot;Fetcher&quot;</span> }) &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Install a signal handlers to catch operating system signals</span></div>
<div class="line">    installSignalHandlers();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Lock the mutex so that main can then wait on it</span></div>
<div class="line">    std::unique_lock lock(moq_example::main_mutex);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> enable_pub{ <span class="keyword">false</span> };</div>
<div class="line">    <span class="keywordtype">bool</span> enable_sub{ <span class="keyword">false</span> };</div>
<div class="line">    <span class="keywordtype">bool</span> enable_fetch{ <span class="keyword">false</span> };</div>
<div class="line">    <span class="keywordtype">bool</span> use_announce{ <span class="keyword">false</span> };</div>
<div class="line">    <a class="code hl_struct" href="structquicr_1_1_client_config.html">quicr::ClientConfig</a> config = InitConfig(result, enable_pub, enable_sub, enable_fetch, use_announce);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">        <span class="keywordtype">bool</span> stop_threads{ <span class="keyword">false</span> };</div>
<div class="line">        <span class="keyword">auto</span> client = MyClient::Create(config, stop_threads);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (client-&gt;Connect() != <a id="_a43" name="_a43"></a><a class="code hl_enumvalue" href="classquicr_1_1_transport.html#a1fc1ea2c9665c591c4eac8a6ff1b6173ab714c11518d545c225d456731dab0dd0">quicr::Transport::Status::kConnecting</a>) {</div>
<div class="line">            SPDLOG_ERROR(<span class="stringliteral">&quot;Failed to connect to server due to invalid params, check URI&quot;</span>);</div>
<div class="line">            exit(-1);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">while</span> (not stop_threads) {</div>
<div class="line">            <span class="keywordflow">if</span> (client-&gt;GetStatus() == MyClient::Status::kReady) {</div>
<div class="line">                SPDLOG_INFO(<span class="stringliteral">&quot;Connected to server&quot;</span>);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            std::this_thread::sleep_for(std::chrono::milliseconds(200));</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        std::thread pub_thread;</div>
<div class="line">        std::thread sub_thread;</div>
<div class="line">        std::thread fetch_thread;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (result.count(<span class="stringliteral">&quot;sub_announces&quot;</span>)) {</div>
<div class="line">            <span class="keyword">const</span> <span class="keyword">auto</span>&amp; prefix_ns = quicr::example::MakeFullTrackName(result[<span class="stringliteral">&quot;sub_announces&quot;</span>].as&lt;std::string&gt;(), <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">auto</span> th = <a id="_a44" name="_a44"></a><a class="code hl_struct" href="structquicr_1_1_track_hash.html">quicr::TrackHash</a>(prefix_ns);</div>
<div class="line"> </div>
<div class="line">            SPDLOG_INFO(<span class="stringliteral">&quot;Sending subscribe announces for prefix &#39;{}&#39; namespace_hash: {}&quot;</span>,</div>
<div class="line">                        result[<span class="stringliteral">&quot;sub_announces&quot;</span>].as&lt;std::string&gt;(),</div>
<div class="line">                        th.track_namespace_hash);</div>
<div class="line"> </div>
<div class="line">            client-&gt;SubscribeAnnounces(prefix_ns.name_space);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (enable_pub) {</div>
<div class="line">            <span class="keyword">const</span> <span class="keyword">auto</span>&amp; pub_track_name = quicr::example::MakeFullTrackName(result[<span class="stringliteral">&quot;pub_namespace&quot;</span>].as&lt;std::string&gt;(),</div>
<div class="line">                                                                           result[<span class="stringliteral">&quot;pub_name&quot;</span>].as&lt;std::string&gt;());</div>
<div class="line"> </div>
<div class="line">            pub_thread = std::thread(DoPublisher, pub_track_name, client, use_announce, std::ref(stop_threads));</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (enable_sub) {</div>
<div class="line">            <span class="keyword">auto</span> filter_type = quicr::messages::FilterType::kLargestObject;</div>
<div class="line">            <span class="keywordflow">if</span> (result.count(<span class="stringliteral">&quot;start_point&quot;</span>)) {</div>
<div class="line">                <span class="keywordflow">if</span> (result[<span class="stringliteral">&quot;start_point&quot;</span>].as&lt;uint64_t&gt;() == 0) {</div>
<div class="line">                    filter_type = quicr::messages::FilterType::kNextGroupStart;</div>
<div class="line">                    SPDLOG_INFO(<span class="stringliteral">&quot;Setting subscription filter to Next Group Start&quot;</span>);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            std::optional&lt;std::uint64_t&gt; joining_fetch;</div>
<div class="line">            <span class="keywordflow">if</span> (result.count(<span class="stringliteral">&quot;joining_fetch&quot;</span>)) {</div>
<div class="line">                joining_fetch = result[<span class="stringliteral">&quot;joining_fetch&quot;</span>].as&lt;uint64_t&gt;();</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordtype">bool</span> absolute = result.count(<span class="stringliteral">&quot;absolute&quot;</span>) &amp;&amp; result[<span class="stringliteral">&quot;absolute&quot;</span>].as&lt;<span class="keywordtype">bool</span>&gt;();</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keyword">auto</span>&amp; sub_track_name = quicr::example::MakeFullTrackName(result[<span class="stringliteral">&quot;sub_namespace&quot;</span>].as&lt;std::string&gt;(),</div>
<div class="line">                                                                           result[<span class="stringliteral">&quot;sub_name&quot;</span>].as&lt;std::string&gt;());</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (qclient_vars::req_track_status) {</div>
<div class="line">                client-&gt;RequestTrackStatus(sub_track_name);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            sub_thread = std::thread(</div>
<div class="line">              DoSubscriber, sub_track_name, client, filter_type, std::ref(stop_threads), joining_fetch, absolute);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (enable_fetch) {</div>
<div class="line">            <span class="keyword">const</span> <span class="keyword">auto</span>&amp; fetch_track_name = quicr::example::MakeFullTrackName(</div>
<div class="line">              result[<span class="stringliteral">&quot;fetch_namespace&quot;</span>].as&lt;std::string&gt;(), result[<span class="stringliteral">&quot;fetch_name&quot;</span>].as&lt;std::string&gt;());</div>
<div class="line"> </div>
<div class="line">            fetch_thread =</div>
<div class="line">              std::thread(DoFetch,</div>
<div class="line">                          fetch_track_name,</div>
<div class="line">                          Range{ result[<span class="stringliteral">&quot;start_group&quot;</span>].as&lt;uint64_t&gt;(), result[<span class="stringliteral">&quot;end_group&quot;</span>].as&lt;uint64_t&gt;() },</div>
<div class="line">                          Range{ result[<span class="stringliteral">&quot;start_object&quot;</span>].as&lt;uint64_t&gt;(), result[<span class="stringliteral">&quot;end_object&quot;</span>].as&lt;uint64_t&gt;() },</div>
<div class="line">                          client,</div>
<div class="line">                          std::ref(stop_threads));</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Wait until told to terminate</span></div>
<div class="line">        moq_example::cv.wait(lock, [&amp;]() { <span class="keywordflow">return</span> moq_example::terminate; });</div>
<div class="line"> </div>
<div class="line">        stop_threads = <span class="keyword">true</span>;</div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;Stopping threads...&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (pub_thread.joinable()) {</div>
<div class="line">            pub_thread.join();</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (sub_thread.joinable()) {</div>
<div class="line">            sub_thread.join();</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (fetch_thread.joinable()) {</div>
<div class="line">            fetch_thread.join();</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        client-&gt;Disconnect();</div>
<div class="line"> </div>
<div class="line">        SPDLOG_INFO(<span class="stringliteral">&quot;Client done&quot;</span>);</div>
<div class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(3000));</div>
<div class="line"> </div>
<div class="line">    } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::invalid_argument&amp; e) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;Invalid argument: &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;</div>
<div class="line">        result_code = EXIT_FAILURE;</div>
<div class="line">    } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;Unexpected exception: &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;</div>
<div class="line">        result_code = EXIT_FAILURE;</div>
<div class="line">    } <span class="keywordflow">catch</span> (...) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;Unexpected exception&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        result_code = EXIT_FAILURE;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    SPDLOG_INFO(<span class="stringliteral">&quot;Exit&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> result_code;</div>
<div class="line">}</div>
<div class="ttc" id="aclassquicr_1_1_client_html"><div class="ttname"><a href="classquicr_1_1_client.html">quicr::Client</a></div><div class="ttdoc">MoQ Client.</div><div class="ttdef"><b>Definition</b> client.h:23</div></div>
<div class="ttc" id="aclassquicr_1_1_client_html_a0d7798afe93e4d24cd61a68ea2ab9586"><div class="ttname"><a href="classquicr_1_1_client.html#a0d7798afe93e4d24cd61a68ea2ab9586">quicr::Client::BindFetchTrack</a></div><div class="ttdeci">void BindFetchTrack(TransportConnId conn_id, std::shared_ptr&lt; PublishFetchHandler &gt; track_handler)</div><div class="ttdoc">Bind a server fetch publisher track handler.</div></div>
<div class="ttc" id="aclassquicr_1_1_client_html_a6941229a7e2f8b978440b1c5e31ac946"><div class="ttname"><a href="classquicr_1_1_client.html#a6941229a7e2f8b978440b1c5e31ac946">quicr::Client::FetchReceived</a></div><div class="ttdeci">bool FetchReceived(quicr::ConnectionHandle connection_handle, uint64_t request_id, const quicr::FullTrackName &amp;track_full_name, const quicr::messages::FetchAttributes &amp;attributes) override</div><div class="ttdoc">Callback on fetch message.</div></div>
<div class="ttc" id="aclassquicr_1_1_client_html_ab22e0b13413ac17fdc3da8abd2f912fc"><div class="ttname"><a href="classquicr_1_1_client.html#ab22e0b13413ac17fdc3da8abd2f912fc">quicr::Client::UnannounceReceived</a></div><div class="ttdeci">virtual void UnannounceReceived(const TrackNamespace &amp;track_namespace)</div><div class="ttdoc">Callback notification for unannounce received by subscribe announces.</div></div>
<div class="ttc" id="aclassquicr_1_1_client_html_abcb67bcd176e798b11301d5e1285c145"><div class="ttname"><a href="classquicr_1_1_client.html#abcb67bcd176e798b11301d5e1285c145">quicr::Client::Create</a></div><div class="ttdeci">static std::shared_ptr&lt; Client &gt; Create(const ClientConfig &amp;cfg)</div><div class="ttdef"><b>Definition</b> client.h:38</div></div>
<div class="ttc" id="aclassquicr_1_1_client_html_ac33e5c121b37a4a51310e0d2758a2eb4"><div class="ttname"><a href="classquicr_1_1_client.html#ac33e5c121b37a4a51310e0d2758a2eb4">quicr::Client::AnnounceReceived</a></div><div class="ttdeci">virtual void AnnounceReceived(const TrackNamespace &amp;track_namespace, const PublishAnnounceAttributes &amp;announce_attributes)</div><div class="ttdoc">Callback notification for announce received by subscribe announces.</div></div>
<div class="ttc" id="aclassquicr_1_1_client_html_ae9e0e0957f93f57d58264836d715c1cc"><div class="ttname"><a href="classquicr_1_1_client.html#ae9e0e0957f93f57d58264836d715c1cc">quicr::Client::SubscribeAnnouncesStatusChanged</a></div><div class="ttdeci">virtual void SubscribeAnnouncesStatusChanged(const TrackNamespace &amp;track_namespace, std::optional&lt; messages::SubscribeNamespaceErrorCode &gt; error_code, std::optional&lt; messages::ReasonPhrase &gt; reason)</div><div class="ttdoc">Callback notification for subscribe announces OK or Error.</div></div>
<div class="ttc" id="aclassquicr_1_1_fetch_track_handler_html"><div class="ttname"><a href="classquicr_1_1_fetch_track_handler.html">quicr::FetchTrackHandler</a></div><div class="ttdef"><b>Definition</b> fetch_track_handler.h:12</div></div>
<div class="ttc" id="aclassquicr_1_1_fetch_track_handler_html_af93401d317fd218737230aec95de416c"><div class="ttname"><a href="classquicr_1_1_fetch_track_handler.html#af93401d317fd218737230aec95de416c">quicr::FetchTrackHandler::Create</a></div><div class="ttdeci">static std::shared_ptr&lt; FetchTrackHandler &gt; Create(const FullTrackName &amp;full_track_name, messages::SubscriberPriority priority, messages::GroupOrder group_order, messages::GroupId start_group, messages::GroupId end_group, messages::GroupId start_object, messages::GroupId end_object)</div><div class="ttdoc">Create shared Fetch track handler.</div><div class="ttdef"><b>Definition</b> fetch_track_handler.h:54</div></div>
<div class="ttc" id="aclassquicr_1_1_publish_fetch_handler_html_a17a782189c94e6e4331fcc23e3c14326"><div class="ttname"><a href="classquicr_1_1_publish_fetch_handler.html#a17a782189c94e6e4331fcc23e3c14326">quicr::PublishFetchHandler::Create</a></div><div class="ttdeci">static std::shared_ptr&lt; PublishFetchHandler &gt; Create(const FullTrackName &amp;full_track_name, uint8_t priority, uint64_t subscribe_id, messages::GroupOrder group_order, uint32_t ttl)</div><div class="ttdef"><b>Definition</b> publish_fetch_handler.h:25</div></div>
<div class="ttc" id="aclassquicr_1_1_publish_track_handler_html"><div class="ttname"><a href="classquicr_1_1_publish_track_handler.html">quicr::PublishTrackHandler</a></div><div class="ttdoc">MOQ track handler for published track.</div><div class="ttdef"><b>Definition</b> publish_track_handler.h:23</div></div>
<div class="ttc" id="aclassquicr_1_1_publish_track_handler_html_a85d2310272db252df775a681cc8b8884"><div class="ttname"><a href="classquicr_1_1_publish_track_handler.html#a85d2310272db252df775a681cc8b8884">quicr::PublishTrackHandler::StatusChanged</a></div><div class="ttdeci">virtual void StatusChanged(Status status)</div><div class="ttdoc">Notification of publish track status change.</div></div>
<div class="ttc" id="aclassquicr_1_1_publish_track_handler_html_ae1d84347753c980a4fba65ed740a94b1"><div class="ttname"><a href="classquicr_1_1_publish_track_handler.html#ae1d84347753c980a4fba65ed740a94b1">quicr::PublishTrackHandler::GetTrackAlias</a></div><div class="ttdeci">std::optional&lt; uint64_t &gt; GetTrackAlias() const noexcept</div><div class="ttdoc">Get the track alias.</div><div class="ttdef"><b>Definition</b> publish_track_handler.h:248</div></div>
<div class="ttc" id="aclassquicr_1_1_subscribe_track_handler_html"><div class="ttname"><a href="classquicr_1_1_subscribe_track_handler.html">quicr::SubscribeTrackHandler</a></div><div class="ttdoc">MOQ track handler for subscribed track.</div><div class="ttdef"><b>Definition</b> subscribe_track_handler.h:22</div></div>
<div class="ttc" id="aclassquicr_1_1_subscribe_track_handler_html_a73d8e7dfc1dfa07809aaec0daea79c37"><div class="ttname"><a href="classquicr_1_1_subscribe_track_handler.html#a73d8e7dfc1dfa07809aaec0daea79c37">quicr::SubscribeTrackHandler::GetTrackAlias</a></div><div class="ttdeci">std::optional&lt; uint64_t &gt; GetTrackAlias() const noexcept</div><div class="ttdoc">Get the track alias.</div><div class="ttdef"><b>Definition</b> subscribe_track_handler.h:166</div></div>
<div class="ttc" id="aclassquicr_1_1_subscribe_track_handler_html_a93b099d6a5c5862e121d6891ac5036af"><div class="ttname"><a href="classquicr_1_1_subscribe_track_handler.html#a93b099d6a5c5862e121d6891ac5036af">quicr::SubscribeTrackHandler::RequestNewGroup</a></div><div class="ttdeci">void RequestNewGroup() noexcept</div><div class="ttdoc">Generate a new group request for this subscription.</div></div>
<div class="ttc" id="aclassquicr_1_1_subscribe_track_handler_html_a9de21a18d0ef99ddba39efc9833d74eea78076a6dd163ca654a4258f3d295d408"><div class="ttname"><a href="classquicr_1_1_subscribe_track_handler.html#a9de21a18d0ef99ddba39efc9833d74eea78076a6dd163ca654a4258f3d295d408">quicr::SubscribeTrackHandler::Status::kPendingResponse</a></div><div class="ttdeci">@ kPendingResponse</div><div class="ttdef"><b>Definition</b> subscribe_track_handler.h:45</div></div>
<div class="ttc" id="aclassquicr_1_1_subscribe_track_handler_html_a9de21a18d0ef99ddba39efc9833d74eeae69fa9a656f76dd8a4d89f21992b2d3a"><div class="ttname"><a href="classquicr_1_1_subscribe_track_handler.html#a9de21a18d0ef99ddba39efc9833d74eeae69fa9a656f76dd8a4d89f21992b2d3a">quicr::SubscribeTrackHandler::Status::kOk</a></div><div class="ttdeci">@ kOk</div><div class="ttdef"><b>Definition</b> subscribe_track_handler.h:40</div></div>
<div class="ttc" id="aclassquicr_1_1_subscribe_track_handler_html_aa4df3bdf8ba34557c381aa0268bc5b7d"><div class="ttname"><a href="classquicr_1_1_subscribe_track_handler.html#aa4df3bdf8ba34557c381aa0268bc5b7d">quicr::SubscribeTrackHandler::ObjectReceived</a></div><div class="ttdeci">virtual void ObjectReceived(const ObjectHeaders &amp;object_headers, BytesSpan data)</div><div class="ttdoc">Notification of received [full] data object.</div></div>
<div class="ttc" id="aclassquicr_1_1_subscribe_track_handler_html_acc562217cd1bb34fc845cdde7a0fe570"><div class="ttname"><a href="classquicr_1_1_subscribe_track_handler.html#acc562217cd1bb34fc845cdde7a0fe570">quicr::SubscribeTrackHandler::StatusChanged</a></div><div class="ttdeci">virtual void StatusChanged(Status status)</div><div class="ttdoc">Notification of subscribe status.</div><div class="ttdef"><b>Definition</b> subscribe_track_handler.h:270</div></div>
<div class="ttc" id="aclassquicr_1_1_track_namespace_html_a32dc15e4ff8867523d2435875a99f00e"><div class="ttname"><a href="classquicr_1_1_track_namespace.html#a32dc15e4ff8867523d2435875a99f00e">quicr::TrackNamespace::GetEntries</a></div><div class="ttdeci">const std::vector&lt; std::span&lt; const uint8_t &gt; &gt; &amp; GetEntries() const noexcept</div><div class="ttdef"><b>Definition</b> track_name.h:174</div></div>
<div class="ttc" id="aclassquicr_1_1_transport_html_a1fc1ea2c9665c591c4eac8a6ff1b6173ab714c11518d545c225d456731dab0dd0"><div class="ttname"><a href="classquicr_1_1_transport.html#a1fc1ea2c9665c591c4eac8a6ff1b6173ab714c11518d545c225d456731dab0dd0">quicr::Transport::Status::kConnecting</a></div><div class="ttdeci">@ kConnecting</div><div class="ttdef"><b>Definition</b> transport.h:54</div></div>
<div class="ttc" id="aclassquicr_1_1_transport_html_aa2d05f889c978960a851175054268e01"><div class="ttname"><a href="classquicr_1_1_transport.html#aa2d05f889c978960a851175054268e01">quicr::Transport::TrackStatusResponseReceived</a></div><div class="ttdeci">virtual void TrackStatusResponseReceived(ConnectionHandle connection_handle, uint64_t request_id, const SubscribeResponse &amp;response)</div><div class="ttdoc">Callback notification for track status OK received.</div></div>
<div class="ttc" id="aclassquicr_1_1_transport_html_af6b023296dcd922a3e590753aaa97bb3"><div class="ttname"><a href="classquicr_1_1_transport.html#af6b023296dcd922a3e590753aaa97bb3">quicr::Transport::StatusChanged</a></div><div class="ttdeci">virtual void StatusChanged(Status status)</div><div class="ttdoc">Callback notification for status/state change.</div><div class="ttdef"><b>Definition</b> transport.h:257</div></div>
<div class="ttc" id="aclient_8h_html"><div class="ttname"><a href="client_8h.html">client.h</a></div></div>
<div class="ttc" id="anamespacequicr_html_a196ac5046236a7e948d3b5a766ac02ee"><div class="ttname"><a href="namespacequicr.html#a196ac5046236a7e948d3b5a766ac02ee">quicr::Bytes</a></div><div class="ttdeci">std::vector&lt; Byte &gt; Bytes</div><div class="ttdef"><b>Definition</b> common.h:20</div></div>
<div class="ttc" id="anamespacequicr_html_a960fb04ec2c5b5aee1ff1b6b125ea4b3ad5dbdf8007e4468c85b9aa91312030e7"><div class="ttname"><a href="namespacequicr.html#a960fb04ec2c5b5aee1ff1b6b125ea4b3ad5dbdf8007e4468c85b9aa91312030e7">quicr::ObjectStatus::kAvailable</a></div><div class="ttdeci">@ kAvailable</div><div class="ttdef"><b>Definition</b> object.h:19</div></div>
<div class="ttc" id="anamespacequicr_html_ae332e51a43d09ae0300bd16654d671fc"><div class="ttname"><a href="namespacequicr.html#ae332e51a43d09ae0300bd16654d671fc">quicr::ConnectionHandle</a></div><div class="ttdeci">uint64_t ConnectionHandle</div><div class="ttdef"><b>Definition</b> common.h:22</div></div>
<div class="ttc" id="anamespacequicr_html_ae70de664ee7965d202a9dfccfbb12e12"><div class="ttname"><a href="namespacequicr.html#ae70de664ee7965d202a9dfccfbb12e12">quicr::BytesSpan</a></div><div class="ttdeci">std::span&lt; const Byte &gt; BytesSpan</div><div class="ttdef"><b>Definition</b> common.h:21</div></div>
<div class="ttc" id="aobject_8h_html"><div class="ttname"><a href="object_8h.html">object.h</a></div></div>
<div class="ttc" id="apublish__fetch__handler_8h_html"><div class="ttname"><a href="publish__fetch__handler_8h.html">publish_fetch_handler.h</a></div></div>
<div class="ttc" id="astructquicr_1_1_client_config_html"><div class="ttname"><a href="structquicr_1_1_client_config.html">quicr::ClientConfig</a></div><div class="ttdef"><b>Definition</b> config.h:22</div></div>
<div class="ttc" id="astructquicr_1_1_client_config_html_aa6b0b5406607428025ea40d64f18d570"><div class="ttname"><a href="structquicr_1_1_client_config.html#aa6b0b5406607428025ea40d64f18d570">quicr::ClientConfig::connect_uri</a></div><div class="ttdeci">std::string connect_uri</div><div class="ttdoc">URI such as moqt://relay[:port][/path?query].</div><div class="ttdef"><b>Definition</b> config.h:23</div></div>
<div class="ttc" id="astructquicr_1_1_config_html_ac61dcd9337d55b4694552338af12fe2e"><div class="ttname"><a href="structquicr_1_1_config.html#ac61dcd9337d55b4694552338af12fe2e">quicr::Config::endpoint_id</a></div><div class="ttdeci">std::string endpoint_id</div><div class="ttdef"><b>Definition</b> config.h:14</div></div>
<div class="ttc" id="astructquicr_1_1_config_html_ad8895576bc8e8fba62da81e6096c1aea"><div class="ttname"><a href="structquicr_1_1_config.html#ad8895576bc8e8fba62da81e6096c1aea">quicr::Config::transport_config</a></div><div class="ttdeci">quicr::TransportConfig transport_config</div><div class="ttdef"><b>Definition</b> config.h:17</div></div>
<div class="ttc" id="astructquicr_1_1_full_track_name_html"><div class="ttname"><a href="structquicr_1_1_full_track_name.html">quicr::FullTrackName</a></div><div class="ttdoc">Full track name struct.</div><div class="ttdef"><b>Definition</b> track_name.h:260</div></div>
<div class="ttc" id="astructquicr_1_1_full_track_name_html_aa1200d2c7858e58eb2370434bb6580ee"><div class="ttname"><a href="structquicr_1_1_full_track_name.html#aa1200d2c7858e58eb2370434bb6580ee">quicr::FullTrackName::name</a></div><div class="ttdeci">std::vector&lt; uint8_t &gt; name</div><div class="ttdef"><b>Definition</b> track_name.h:262</div></div>
<div class="ttc" id="astructquicr_1_1_full_track_name_html_aca157ed8599522f1690820a720b6b722"><div class="ttname"><a href="structquicr_1_1_full_track_name.html#aca157ed8599522f1690820a720b6b722">quicr::FullTrackName::name_space</a></div><div class="ttdeci">TrackNamespace name_space</div><div class="ttdef"><b>Definition</b> track_name.h:261</div></div>
<div class="ttc" id="astructquicr_1_1_object_headers_html"><div class="ttname"><a href="structquicr_1_1_object_headers.html">quicr::ObjectHeaders</a></div><div class="ttdoc">Object headers struct.</div><div class="ttdef"><b>Definition</b> object.h:32</div></div>
<div class="ttc" id="astructquicr_1_1_object_headers_html_a05928bdabd0ac8c294486dba35099d18"><div class="ttname"><a href="structquicr_1_1_object_headers.html#a05928bdabd0ac8c294486dba35099d18">quicr::ObjectHeaders::subgroup_id</a></div><div class="ttdeci">uint64_t subgroup_id</div><div class="ttdoc">Subgroup ID - Starts at 0, monotonically increases by 1.</div><div class="ttdef"><b>Definition</b> object.h:35</div></div>
<div class="ttc" id="astructquicr_1_1_object_headers_html_a544ac7b64c29d3adec1e76b4efefa5d5"><div class="ttname"><a href="structquicr_1_1_object_headers.html#a544ac7b64c29d3adec1e76b4efefa5d5">quicr::ObjectHeaders::object_id</a></div><div class="ttdeci">uint64_t object_id</div><div class="ttdoc">Object ID - Application defined order of generation.</div><div class="ttdef"><b>Definition</b> object.h:34</div></div>
<div class="ttc" id="astructquicr_1_1_object_headers_html_a5df4640f77a5d99d30563728691bc501"><div class="ttname"><a href="structquicr_1_1_object_headers.html#a5df4640f77a5d99d30563728691bc501">quicr::ObjectHeaders::extensions</a></div><div class="ttdeci">std::optional&lt; Extensions &gt; extensions</div><div class="ttdef"><b>Definition</b> object.h:41</div></div>
<div class="ttc" id="astructquicr_1_1_object_headers_html_a5f95043ef8044f6497e9eedc8cd20ff9"><div class="ttname"><a href="structquicr_1_1_object_headers.html#a5f95043ef8044f6497e9eedc8cd20ff9">quicr::ObjectHeaders::group_id</a></div><div class="ttdeci">uint64_t group_id</div><div class="ttdoc">Object group ID - Application defined order of generation.</div><div class="ttdef"><b>Definition</b> object.h:33</div></div>
<div class="ttc" id="astructquicr_1_1_object_headers_html_a6ae96ec0cf4ad374d52d181f35ce7e11"><div class="ttname"><a href="structquicr_1_1_object_headers.html#a6ae96ec0cf4ad374d52d181f35ce7e11">quicr::ObjectHeaders::immutable_extensions</a></div><div class="ttdeci">std::optional&lt; Extensions &gt; immutable_extensions</div><div class="ttdef"><b>Definition</b> object.h:42</div></div>
<div class="ttc" id="astructquicr_1_1_object_headers_html_a7f1dbb9d56ecaa769b7b43128215c4bc"><div class="ttname"><a href="structquicr_1_1_object_headers.html#a7f1dbb9d56ecaa769b7b43128215c4bc">quicr::ObjectHeaders::priority</a></div><div class="ttdeci">std::optional&lt; uint8_t &gt; priority</div><div class="ttdoc">Priority of the object, lower value is better.</div><div class="ttdef"><b>Definition</b> object.h:38</div></div>
<div class="ttc" id="astructquicr_1_1_object_headers_html_ad15c80dbc8580017173694db9db4d0d2"><div class="ttname"><a href="structquicr_1_1_object_headers.html#ad15c80dbc8580017173694db9db4d0d2">quicr::ObjectHeaders::payload_length</a></div><div class="ttdeci">uint64_t payload_length</div><div class="ttdoc">Length of payload of the object data.</div><div class="ttdef"><b>Definition</b> object.h:36</div></div>
<div class="ttc" id="astructquicr_1_1_subscribe_track_handler_1_1_joining_fetch_html"><div class="ttname"><a href="structquicr_1_1_subscribe_track_handler_1_1_joining_fetch.html">quicr::SubscribeTrackHandler::JoiningFetch</a></div><div class="ttdoc">Attributes to use when subscribing with a Joining Fetch.</div><div class="ttdef"><b>Definition</b> subscribe_track_handler.h:55</div></div>
<div class="ttc" id="astructquicr_1_1_track_hash_html"><div class="ttname"><a href="structquicr_1_1_track_hash.html">quicr::TrackHash</a></div><div class="ttdef"><b>Definition</b> track_name.h:283</div></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
